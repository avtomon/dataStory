#DataStory

DataStory представляет собой представляет собой абстракцию доступа к СУБД посредством PDO с прослойкой из кэша. 

Основной фичей является прозрачное кэширование результатов запросов в хранилище кэшей (Redis или Memcached) и прозрачная же инвалидация кэша на изменяющих запросах.

<br>

### Установка

```
composer require avtomon/datastory
```

<br>

### Механика работы

Инвалидация кэша происходит при помощи тегирования запросов: мы очищаем некоторое количество ключей кэша принадлежащих определённому тегу, в качестве тегов может быть всё что угодно, но в DataStory используются имена таблиц базы данных, то есть при изменении определенной таблицы считать неактуальными кеши которые относятся к этой таблице.

Подсистема тегирования выделяет имена таблиц использующихся в запросе. Для этого изначально собираютс все таблицы, к которым могут идти запросы. Это просиходит автоматически. 

При запросе к DataStory определяется тип запроса: запрос на чтение или запрос на изменение данных. Запросы на изменение данных это INSERT, UPDATE или DELETE, соответственно запрос на чтение это запрос SELECT. 

Cложные запросы, например, запросы c CTE к PostgreSQL, когда один запрос может содержать одновременно читающие и изменяющие операторы однозначно определяются изменяющими, если содержат хотя бы один оператор INSERT, UPDATE или DELETE.

Кроме того существуют запросы использующие хранимые процедуры, для которых сложно предсказать заранее является ли запрос читающим или изменяющим. Для таких запросом изменяющий флаг можно передать явно:

```

$dataStory->setIsModifying(true);

```

И так, если система однозначно определила что запрос является запросом на чтение сначала она пытается найти его результат в кэше, ключом кэша является хэш от пары: текст запроса + сериализованные параметры запроса, либо если параметров запроса нет, то просто хэш от текста запроса. 

Если в кэше результата запроса не оказалось или этот результат не актуален: таблицы, из которых запрашиваются данные изменились после сохранения элемента кэша, то система идет в базу данных, забирает оттуда результат, возвращает его клиенту и сохраняет его в кэше. Пока сохранение в кэш происходит в синхронном режиме, однако, в будущем планируется сделать его асинхронным.

Если же запрос является изменяющим, он исполняется, затем таблицы запроса сохраняются как элементы кэша, для которых ключом является имя таблицы, а значением время изменения таблицы.

Использование модуля

Имеем таблицу книг (books):

|  id | title | ISBN | description |
| --- | --- | --- | --- |
| 1 | PHP Web Services | 9781449356569 |  |
| 2 | Architect's Pocket Php Reference | 0973862130 |  |
| 3 | Php String Handling Handbook | 186100835X | Book DescriptionThis book will cover all the most important tasks related to dealing with text/strings in PHP... |

и запрос

```

$query = 'SELECT * FROM books WHERE id = :id';

```

Если выполнить следующий код:

```
$dataStory = DataStory::create($query, ['id' => 3]);

$dataStory->getValue($prefix)
```

то к кэше пока ничего не будет - DataStory сходит в базу данных, отдаст результат и сохранит его в кэш, но при последующих запросах **от этого и других клиентов** результат будет возвращен из кэша.

Если затем выполнить:

```
$query = 'UPDATE books SET id = 4 WHERE id = :id';
$dataStory = DataStory::create($query, ['id' => 2]);

$dataStory->getValue($prefix)

```

то кэш для таблицы *books* сбросится и следующий за этим запрос на чтение из таблицы *books* пойдет за данными в БД.

<br>

Кроме того система содержит методы сохранение HTML-страниц и манипуляций с ними.

```

$dataStory->getHtml($verifyingFilePath = '');
$dataStory->setHtml($html, $tags = []);
$dataStory->deleteHtml();

```

Разметка сохраненных страниц может быть инвалидированна по тем же правилам что и результаты запросов, т. е.
необходимо связать страницу с таблицами базы данных, из которых загружается информация (параметр `$tags` метода `setHtml`). Кроме того для инвалидации можно проверять на изменение сам файл шаблона страницы (предположительно HTML-файл) и сбрасывать кэш страницы, если шаблон изменился.

<br>

[Документация классов](docs_ru)
